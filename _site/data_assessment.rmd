---
title: "CoronaNet Data Assessment"
output: html_document
---

<style type="text/css">
.table {

    width: 40%;

}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
knitr::opts_knit$set(root.dir = '~/')
library(rgeos)
library(tidyr)
library(dplyr)
library(ggnewscale)
library(ggplot2)
library(RColorBrewer)
library(tmap)
library(sf)
library(zoo)
library(stringi)
`%!in%` <- Negate(`%in%`)
library(here)
library(DT)

sub_nat = 
  c(
    "Brazil",
    "China",
    "Italy",
    "France",
    "Germany",
    "India",
    "Spain",
    "Japan",
    "Australia",
    "Canada",
    "Nigeria",
    "Switzerland",
    "United States",
    "Russia"
  )

# -------------------
# load qualtrics data
# -------------------
ra_data_pull_purified<-readRDS(here("data", "CoronaNet", "RA", "ra_data_pull_purified.RDS"))

# -------------------
# load and clean assessment data
# -------------------


int_assess_google_clean = readRDS(
  here("data", "dataQuality",  "internal_survey", "quarterly_assessment", "full_quarterly_assessment_clean.rds"))

 

# summarise info from ra internal survey at the subnational level
int_assess_agg_sub_nat = int_assess_google_clean %>%
  ungroup()%>%
 # filter(!is.na(province)) %>% 
  group_by(country,   province, survey ) %>%
  summarise(
    country = unique(country),
    assessor_name = paste(unique(na.omit(ra_name)), collapse = ','),
    actual_cat = paste(unique(na.omit(actual_cat)), collapse = ','),
    actual_date = mean.Date(as.Date(actual_date, "%m-%d-%Y"), na.rm = TRUE),
    
    target_date = max(as.Date(target_date, "%m-%d-%Y"), na.rm = TRUE),
    
    complete_sum = 
      ifelse(all(complete =="I don't know"), "I don't know",    round(mean(complete_num, na.rm = TRUE),1) %>% as.character()),
    clean_sum =   ifelse(all(clean =="I don't know"), "I don't know",    round(mean(clean_num, na.rm = TRUE),1) %>% as.character()),
    complexity_sum =   ifelse(all(complexity =="I don't know"), "I don't know",    round(mean(complexity_num, na.rm = TRUE),1) %>% as.character()),
    survey= unique(survey)
  )  %>%
  mutate(
    complete_sum = ifelse(complete_sum == "I don't know", NA, complete_sum) %>% as.numeric,
    clean_sum = ifelse(clean_sum == "I don't know", NA, complete_sum) %>% as.numeric,
    complexity_sum = ifelse(complexity_sum == "I don't know", NA, complete_sum) %>% as.numeric) %>%
  group_by(country, province) %>%
  arrange(desc(survey)) %>%
  slice(1) %>%
  ungroup %>%
  dplyr::select(id = province, everything())


 

# summarise info from ra internal survey at the national level
int_assess_agg_nat =
  int_assess_google_clean %>%
  group_by(country, survey ) %>%
  summarise(
    survey= unique(survey),
    assessor_name = paste(unique(na.omit(ra_name)), collapse = ','),
    actual_cat = paste(unique(na.omit(actual_cat)), collapse = ','),
    actual_date = mean.Date(as.Date(actual_date, "%m-%d-%Y"), na.rm = TRUE),
    target_date = max(as.Date(target_date, "%m-%d-%Y"), na.rm = TRUE),
    
    complete_sum = 
      ifelse(all(complete =="I don't know"), "I don't know",    round(mean(complete_num, na.rm = TRUE),1) %>% as.character()),
    clean_sum =   ifelse(all(clean =="I don't know"), "I don't know",    round(mean(clean_num, na.rm = TRUE),1) %>% as.character()),
    complexity_sum =   ifelse(all(complexity =="I don't know"), "I don't know",    round(mean(complexity_num, na.rm = TRUE),1) %>% as.character()))%>%
  
  mutate(
    complete_sum = ifelse(complete_sum == "I don't know", NA, complete_sum) %>% as.numeric,
    clean_sum = ifelse(clean_sum == "I don't know", NA, complete_sum) %>% as.numeric,
    complexity_sum = ifelse(complexity_sum == "I don't know", NA, complete_sum) %>% as.numeric) %>%

  group_by(country) %>%
  arrange(desc(survey)) %>%
  slice(1) %>%
  ungroup %>%
  dplyr:::select(id = country, everything())


############
# load goals data
###########

goals_df = readRDS( here("data", "dataQuality", "internal_survey", "monthly_survey", "feb_2023_monthly_survey.rds"))

goals_agg = goals_df %>%
  ungroup%>% 
  mutate(goal_date = as.Date(goal_date, "%m-%d-%Y"),
         
         # check if you need this code after feb 2023
          goal_date = case_when(
           goal_date  > as.Date("2021-10-01", "%Y-%m-%d") ~  as.Date("2021-10-01", "%Y-%m-%d"),
           TRUE ~ goal_date
         ),
         goal_num = 
           case_when(
           #  goal_num == '10-15' ~ 12,
             TRUE ~ as.numeric(goal_num)
           )
         ) %>%
  dplyr:::group_by(country, province) %>%
  dplyr:::summarise(
    goal_date = mean.Date(goal_date, na.rm = TRUE),
    goal_num = sum(goal_num, na.rm = TRUE),
    goals_activity = unique(goals_activity),
    ra_activity = ra_activity
  )%>%
  ungroup%>%
  mutate(
    goal_num = ifelse(goal_num == 0, NA, goal_num)
  ) %>% 
  distinct 


################
# load raw data
################
data_integration_log<-readRDS( file = here("data", "collaboration", "data_integration_log.rds"))
data_integration_log = data_integration_log %>%
  mutate(province = ifelse(province == 'NA', as.character(NA), province))

################
# load base maps
################

world_df<-readRDS(here( "data", "regions", "world_map_shp.rds"))
world_df_sub = world_df %>% filter(id %!in% sub_nat)

shp_df<-readRDS(here( "data", "regions", "world_iso2_map_shp.rds"))
shp_df_sub = shp_df %>% filter(NAME_0 %in% sub_nat)

gg <- ggplot()
gg <- gg + geom_blank(data=shp_df_sub, aes(long, lat))
gg <- gg + geom_map(data=shp_df_sub, map=shp_df_sub,
                    aes( map_id=id), fill = 'white', color = "#7f7f7f",
                    size=0.2)
gg <- gg + geom_map(data=world_df_sub
                    , map=world_df_sub,
                    aes( map_id=id), fill = 'white', color = "#7f7f7f",
                    size=0.2)
```

# Overview

This document produces map visualizations and tables of the data in order to assess progress toward the [CoronaNet Project Goals](https://www.coronanet-project.org/coronanet_goals){target="_blank"}. These assessments were done using the version of the data in the Shiny App along the following criteria:

* Goals and Activity
  + RM/CM Assessment: Goals for Spring 2023
  + RM/CM Assessment: Activity in Spring 2023
  + Most Recent Activity
* Volume of Data
  + Number of policies coded in total
  + Number of policies coded by quarter
* Data Completeness
  + RA Internal Assessment: Approximate date the data is coded until 
  + RA Internal Assessment: Policy Completeness
  + Amount of external data to integrate
* Data Quality 
  + Policy Cleanness
  + Number of missing end dates 
* Data Complexity
  + RA Internal Assessment: Policy Complexity  
  + RA Internal Assessment: Subnational Policy Making


For more information on the questions asked in the RA Internal Assessment, see the [printed version of the survey here](https://www.coronanet-project.org/ra_internal_survey){target="_blank"}. 


# Assessment Maps and Tables {.tabset .tabset-pills}


## Goals and Activity 


### Spring 2023 Goals {.tabset}

The map and tables shows the goals made for each region in Spring 2023 where goals are made either in terms of the date an RA is aspiring to the their data coded up until or the number of polices an RA is aiming to code



#### Map
```{r goals}

goals =gg + geom_map(data= goals_agg %>% dplyr:::select(id = province, everything()),
                        map=shp_df_sub,
                        aes(fill=goal_num, map_id=id  ),
                        size=0.1) 



goals= goals + geom_map(data= goals_agg %>% dplyr:::select(id = country, everything()),
                              map=world_df_sub,
                              aes(fill=goal_num, map_id=id  ),
                              size=0.1)
goals =goals +  new_scale_fill(  )+ geom_map(data= goals_agg %>% dplyr:::select(id = province, everything()),
                                             map=shp_df_sub,
                                             aes(fill=goal_date, map_id=id  ),
                                             size=0.1) 

goals= goals + geom_map(data= goals_agg %>% dplyr:::select(id = country, everything()),
                        map=world_df_sub,
                        aes(fill=goal_date, map_id=id  ),
                        size=0.1)


goals +
   theme_void()+
  coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)
 
```

#### Table

```{r goal_table}

DT::datatable(goals_agg%>% dplyr::select(country, province, goal_num, goal_date),
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')

```



### Spring 2023 RA Activity  {.tabset}

The map and tables shows the amount of activity devoted by each RA in a given country or subnational region



#### Map
```{r activity}

goals_agg$ra_activity = factor(goals_agg$ra_activity,
                                   
                                   levels = c("Other type of activity",
                                              "Active for less than a half of the reporting period",
                                              "Active for half of the reporting period",
                                              "Active for more than a half of the reporting period",
                                              "Yes, contributed at least 5-10 hours a week"
                                     
                                   )
                                   )


gactivity =gg + geom_map(data= goals_agg %>% dplyr:::select(id = province, everything()),
                     map=shp_df_sub,
                     aes(fill=ra_activity, map_id=id  ),
                     size=0.1) 



gactivity= gactivity + geom_map(data= goals_agg %>% dplyr:::select(id = country, everything()),
                        map=world_df_sub,
                        aes(fill=ra_activity, map_id=id  ),
                        size=0.1)
gactivity+
  theme_void()+
  labs(fill = "RA Activity")+
  scale_fill_viridis_d()+
  coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75) 




```





#### Table

```{r activity_table}

DT::datatable(goals_agg%>% dplyr::select(country, province, ra_activity),
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')
```


### Most Recent Record {.tabset}

The map and tables shows the most recent record entered for a given country or subnational region. This data is relative to data pulled from `r ra_data_pull_purified %>% select(recorded_date) %>% pull %>% max `. 

#### Map
```{r update, message = FALSE}

### timing of policies

coronanet_time = ra_data_pull_purified%>%
  mutate(country = ifelse(country ==  "United States of America", "United States", country ))%>% 
  mutate(recorded_date = as.Date(recorded_date, "%Y-%m-%d")) %>%
  filter(! (country %!in% sub_nat & !is.na(province))  )%>% 
  arrange(desc(recorded_date)) %>% 
  group_by(country, province) %>%
  slice(1) %>% 
  ungroup() %>%
  filter(!is.na(country))

# by countries


time_policies= gg + geom_map(data= coronanet_time %>% dplyr:::select(id = province, everything()),
                                        map=shp_df_sub,
                                        aes(fill=recorded_date, map_id=id  ),
                                        size=0.1)

time_policies= time_policies + geom_map(data= coronanet_time %>% dplyr:::select(id = country, everything()),
                             map=world_df_sub,
                             aes(fill=recorded_date, map_id=id  ),
                             size=0.1)




time_policies = time_policies +
  labs(fill='Most Recent Record')+ 
  coord_equal() +
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75) 

myBreaks <- function(x){
  breaks <- c(min(x),median(x),max(x))
  attr(breaks,"labels") <- as.Date(breaks, origin="1970-01-01")
  names(breaks) <- attr(breaks,"labels")
  return(breaks)
}

library(viridis)
time_policies <- time_policies +  
  scale_fill_gradientn(
    colors = magma(6), breaks=myBreaks) +
  labs(color="Date")+
  theme_void()

time_policies+
    coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)

```

#### Table

```{r update_table}

DT::datatable(coronanet_time%>% dplyr::select(country, province, recorded_date),
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')
```


## Volume of Data

### Number of policies coded in total {.tabset }

This map and table shows the total number of policies coded per country or subnational region up until `r ra_data_pull_purified %>% select(recorded_date) %>% pull %>% max `. 

* The first map shows the number of policies for for countries as a whole
* The second map the number of policies split out by subnational regions for the 12 countries were are systematically collecting subnational data for. Note this map does not include information on national level policies for these 12 countries. 

#### Maps
```{r policies,  fig.width=10, message = FALSE}

num_policies = ra_data_pull_purified %>%
  mutate(
    quarter = as.yearqtr(recorded_date, format = "%Y-%m-%d"),
    province = ifelse(country %!in% sub_nat, NA, province)
    ) %>%
  group_by(country, province, quarter) %>%
  arrange(quarter) %>% 
  summarise(
    policies = n()
  ) %>% 
  mutate(
    policies_text = case_when(
      policies <= 25 ~ "0 to 25",
      policies > 25 & policies<=50 ~ "25 to 50",
      policies > 50 & policies<=100 ~ "51 to 100",
      policies > 100 & policies<=200 ~ "101 to 200",
      policies > 200  ~ "More than 200"),
    quarter = as.character(quarter)
    
  ) %>%
  distinct

# tot policies

num_policies_sub_agg =  num_policies %>% 
  group_by(country, province) %>%
  summarise(
    policies = sum(policies, na.rm = TRUE)
  ) %>%
  ungroup %>%
  mutate(
      policies_text = case_when(
        policies <= 25 ~ "0 to 25",
        policies > 25 & policies<=50 ~ "25 to 50",
        policies > 50 & policies<=100 ~ "51 to 100",
        policies > 100 & policies<=200 ~ "101 to 200",
        policies > 200 & policies <=300  ~ "201 to 300",
        policies > 300 & policies <=400  ~ "301 to 400",
        policies > 400  ~ "More than 400",
      )
  ) 

num_policies_sub_agg$policies_text <- factor( num_policies_sub_agg$policies_text, 
                                              levels = c("0 to 25", 
                                                         "25 to 50", 
                                                         "51 to 100",
                                                         '101 to 200',
                                                         '201 to 300',
                                                         '301 to 400',
                                                         'More than 400'
                                              ))

num_policies_agg =  num_policies %>% 
  group_by(country) %>%
  summarise(
    policies = sum(policies, na.rm = TRUE)
  ) %>%
  ungroup %>%
  mutate(
    policies_text = case_when(
      policies <= 50 ~ "0 to 50",
      policies > 50 & policies<=100 ~ "51 to 100",
      policies > 100 & policies<=200 ~ "101 to 200",
      policies > 200 & policies <=500  ~ "201 to 500",
      policies > 500 & policies <=2000 ~ "501 to 2000",
      policies > 2000 & policies <=5000 ~ "2001 to 5000",
      policies > 5000 & policies <=7000 ~ "5001 to 7000",
      policies > 13000  ~ "More than 13,000",
    )
  ) 

num_policies_agg$policies_text <- factor( num_policies_agg$policies_text, 
                                              levels = c("0 to 50", 
                                                         "51 to 100",
                                                         '101 to 200',
                                                         '201 to 500',
                                                         '501 to 2000',
                                                        '2001 to 5000',
                                                        '5001 to 7000',
                                                        'More than 13,000'
                                              )) 
# by countries
agg_policies= gg + geom_map(data= num_policies_agg %>% select(id = country, everything()),
                                              map=world_df,
                                              aes(fill=policies_text, map_id=id  ),
                                              size=0.1)

agg_policies +
  theme_void()+
  scale_fill_viridis_d(na.value = "grey70")+
  labs(fill='Number of Policies')+
  coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)

#by countries and subnat
agg_policies_sub =gg + geom_map(data= num_policies_sub_agg %>% select(id = province, everything()),
                        map=shp_df_sub,
                        aes(fill=policies_text, map_id=id  ),
                        size=0.1)


agg_policies_sub= agg_policies_sub + geom_map(data= num_policies_sub_agg %>% select(id = country, everything()),
                              map=world_df_sub,
                              aes(fill=policies_text, map_id=id  ),
                              size=0.1)

agg_policies_sub +
   theme_void()+
  scale_fill_viridis_d(na.value = "grey70")+
  labs(fill='Number of Policies')+
  coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)
 
```

#### Table
<div style = "width:75%; height:75%; margin: auto;">
```{r policies_table}

DT::datatable(num_policies_sub_agg%>% select(country, province, policy_num = policies),
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')

```
</div>



### Number of Policies by Quarter {.tabset}

The map and table below shows the total number of policies coded per country or subnational region in each quarter.  Note the map does not include information on national level policies for these 12 countries.

#### Map
```{r policies_time, fig.height=12, fig.width = 9 }

num_policies$policies_text <- factor( num_policies$policies_text,
                             levels = c("0 to 25",
                                        "25 to 50",
                                        "51 to 100",
                                        '101 to 200',
                                        'More than 200'
                             ))

policies =gg + geom_map(data= num_policies %>% select(id = province, everything()),
                        map=shp_df_sub,
                        aes(fill=policies_text, map_id=id  ),
                        size=0.1)


policies= policies + geom_map(data= num_policies %>% select(id = country, everything()),
                              map=world_df_sub,
                              aes(fill=policies_text, map_id=id  ),
                              size=0.1)
policies <-  policies + facet_wrap(~quarter, ncol = 2)+
  scale_fill_viridis_d(na.value = "grey70")+
  theme_void()

policies+
  labs(fill='Number of Policies')+
  theme_void()



```

#### Table
<div style = "width:75%; height:75%; margin: auto;">
```{r policies_qrt_table}


DT::datatable(num_policies %>% select(country, province, quarter, policy_num = policies),
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')

```
</div>

## Data Completeness

### RA Internal Assessment: Approximate date policies are coded until according to the RA Internal Assessment Survey {.tabset}

This map and table shows thee average actual date policies in a given country or subnational region are coded up until over all policies types, according to the latest RA Internal Assessment Survey (August 2022 + March 2022 + December 2021 + September 2021)

#### Map
```{r actual_date}
 dates <- gg + geom_map(data=int_assess_agg_sub_nat, map=shp_df,
                    aes(fill=actual_date, map_id=id),
                    size=0.15)
dates <- dates + geom_map(data=int_assess_agg_nat, map=world_df_sub,
                    aes(fill=actual_date, map_id=id),
                    size=0.15)

dates +
  theme_void()+
  labs(fill='Actual Date Policies Coded Until') +
  coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)
```

#### Table
<div style = "width:75%; height:75%; margin: auto;">
```{r actual_date_table}

DT::datatable(int_assess_agg_sub_nat %>%
                arrange(country) %>%
                select(
                   survey,
                  country,
                  province = id,
                 # assessor_name,
                   target_date,
                  average_actual_date = actual_date
                   
                ),
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')

```
</div>




### RA Internal Assessment: Policy Completeness {.tabset}


This map and table show how complete the data is according to the latest RA Internal Assessment Survey (March 2022 +  December 2021 + September 2021). The map displays the average policy completeness across all policy types for a given country or subnational region based on the following rubric:

* 1: Looks complete to me
* 2: Mostly there
* 3: About halfway there
* 4: A lot of work left to do

Note that the map sorts this information by the target date that the region is currently being coded up toward.

#### Map
```{r complete, message = FALSE }
complete <- gg + geom_map(data=int_assess_agg_sub_nat%>%
                      filter(target_date == '2020-10-01'),
                    map=shp_df_sub,
                    aes(fill=complete_sum, map_id=id  ),
                    size=0.15) +
  scale_fill_gradient(name = "Target: October 1, 2020", low = 'lightblue1', high = 'dodgerblue4',guide = guide_legend(order = 1))

complete <- complete + geom_map(data=int_assess_agg_nat %>%
                      filter(target_date == '2020-10-01')
                    , map=world_df_sub,
                    aes(fill=complete_sum, map_id=id),
                    size=0.15)

complete <- complete +
  new_scale_fill(  )+
  geom_map(data=int_assess_agg_sub_nat%>%
             filter(target_date == '2021-03-01'),
           map=shp_df_sub,
           aes(fill=complete_sum, map_id=id  ),
           size=0.15) +
  scale_fill_gradient(name = "Target: March 1, 2021", low = 'palegreen', high = 'darkcyan',guide = guide_legend(order = 2))

complete <- complete + geom_map(data=int_assess_agg_nat %>%
                      filter(target_date == '2021-03-01')
                    , map=world_df_sub,
                    aes(fill=complete_sum, map_id=id),
                    size=0.15)


complete <- complete +
  new_scale_fill(  )+
  geom_map(data=int_assess_agg_sub_nat%>%
             filter(target_date == '2021-10-01'),
           map=shp_df_sub,
           aes(fill=complete_sum, map_id=id  ),
           size=0.15) +
  scale_fill_gradient(name = "Target: October 1, 2021", low = 'plum', high = 'darkorchid4',guide = guide_legend(order = 3))

complete <- complete + geom_map(data=int_assess_agg_nat %>%
                      filter(target_date == '2021-10-01')
                    , map=world_df_sub,
                    aes(fill=complete_sum, map_id=id),
                    size=0.15)

complete+
  theme_void()+
  coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)

```

#### Table
<div style = "width:75%; height:75%; margin: auto;">
```{r complete_table}

DT::datatable(int_assess_agg_sub_nat %>%
                arrange(country) %>%
                select(
                  survey,
                  country,
                  province = id,
                    target_date,
                 complete_sum
                ),
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')

```
</div>




### Data Integration {.tabset}

This map and table show how much data these is to potentially integrate from the external data. For more information on the external data, see the [data integration guidelines](https://www.coronanet-project.org/data_integration_guidelines){target="_blank"}. This data is up to date until `r max(data_integration_log$recorded_week_overlap, na.rm = TRUE)`. The two maps below show:

* The first map shows the number of policies for for countries as a whole in the external data
* The second map the number of policies in the external data split out by subnational regions for the 12 countries were are systematically collecting subnational data for. Note this map does not include information on national level policies for these 12 countries.

#### Maps
```{r external, message = FALSE }

data_integration_log =
  data_integration_log %>%
  mutate(
    country = case_when(
      country ==  "United States of America"~'United States',
      country =='Timor Leste'~  'Timor-Leste',
      TRUE ~ country
    )
  )



# total number of  data integration by country

agg_data_integration = data_integration_log  %>%
  group_by(country) %>%
  summarise(
    tot_policies = n(),
    tot_overlap_assessment = length(which(!is.na(overlap_assessment))),
    tot_integrate_assessment = length(which(!is.na(integrate_assessment))),
    perc_overlap_assessment = tot_overlap_assessment/tot_policies,
    perc_integrate_assessment = tot_integrate_assessment/tot_policies
  ) %>%
  ungroup %>%
  mutate(
    tot_policies_text = case_when(
      tot_policies == 0 ~ as.character(NA),
      tot_policies>0 & tot_policies <= 300 ~'1 to 300',
      tot_policies>300 & tot_policies<=500 ~ '301 to 500',
      tot_policies>500 & tot_policies<=2000 ~ '501 to 2000',
      tot_policies>2000 & tot_policies<=5000 ~ '2001 to 5000',
      tot_policies>5000 & tot_policies<=10000 ~ '5001 to 10000',
      tot_policies>30000 ~ 'More than 30,000'
    ),
    tot_overlap_assessment_text = case_when(
      tot_overlap_assessment  == 0 & tot_policies == 0 ~ as.character(NA),
      tot_overlap_assessment  == 0 & tot_policies != 0 ~ '0',
      tot_overlap_assessment >0 & tot_overlap_assessment<= 100 ~ '1 to 100',
      tot_overlap_assessment >100 & tot_overlap_assessment<= 200 ~ '101 to 200',
      tot_overlap_assessment >200 & tot_overlap_assessment<= 300 ~ '201 to 300',
      tot_overlap_assessment >300 & tot_overlap_assessment<= 400 ~ '301 to 400',
      tot_overlap_assessment>400 & tot_overlap_assessment < 500  ~ '401 to 500',
       tot_overlap_assessment>500    ~ 'More than 500',
    ),
    tot_integrate_assessment_text = case_when(

      tot_integrate_assessment  == 0 & tot_policies == 0 ~ as.character(NA),
      tot_integrate_assessment  == 0 & tot_policies != 0 ~ '0',
      tot_integrate_assessment >0 & tot_integrate_assessment<= 25 ~ '1 to 25',
      tot_integrate_assessment >25 & tot_integrate_assessment<= 50 ~ '26 to 50',
      tot_integrate_assessment >50 & tot_integrate_assessment <= 100 ~ '51 to 100',
      tot_integrate_assessment >100 & tot_integrate_assessment <= 200 ~ '101 to 200',
        tot_integrate_assessment >200 ~ 'More than 200'
    ),
    
    perc_overlap_assessment_text = 
      case_when(
      perc_overlap_assessment == 0 & tot_policies == 0 ~ as.character(NA),
      perc_overlap_assessment == 0 & tot_policies !=0 ~ '0',
       perc_overlap_assessment >0 &  perc_overlap_assessment<=0.25 ~ '0.1 to 0.25',
       perc_overlap_assessment >.25 &  perc_overlap_assessment<=0.5 ~ '0.25 to 0.50',
     perc_overlap_assessment >.5 &  perc_overlap_assessment<=0.75 ~ '0.50 to 0.75',
     perc_overlap_assessment >.75 &  perc_overlap_assessment<1 ~ '0.75 to 0.99',
     perc_overlap_assessment == 1 ~ '100% complete', 
    ),
        perc_integrate_assessment_text = 
      case_when(
      perc_integrate_assessment == 0 & tot_policies == 0 ~ as.character(NA),
      perc_integrate_assessment == 0 & tot_policies !=0 ~ '0',
       perc_integrate_assessment >0 &  perc_integrate_assessment<=0.25 ~ '0.1 to 0.25',
       perc_integrate_assessment >.25 &  perc_integrate_assessment<=0.5 ~ '0.25 to 0.50',
     perc_integrate_assessment >.5 &  perc_integrate_assessment<=0.75 ~ '0.50 to 0.75',
     perc_integrate_assessment >.75 &  perc_integrate_assessment<1 ~ '0.75 to 0.99',
      perc_integrate_assessment == 1 ~ '100% complete', 
     
    ),
    
  )



agg_data_integration$tot_overlap_assessment_text <- factor( agg_data_integration$tot_overlap_assessment_text,
                                                      levels = c(
                                                                 '1 to 100',
                                                                 '101 to 200',
                                                                 '201 to 300',
                                                                 '301 to 400',
                                                                 '401 to 500',
                                                                 'More than 500'

                                                      ))


agg_data_integration$tot_integrate_assessment_text <- factor( agg_data_integration$tot_integrate_assessment_text,
                                                  levels = c(
                                                             '1 to 25',
                                                             '26 to 50',
                                                             '51 to 100',
                                                             '101 to 200',
                                                             'More than 200'
                                                  ))


agg_data_integration$perc_overlap_assessment_text <- factor( agg_data_integration$perc_overlap_assessment_text,
                                                      levels = c(
                                                                 '0.1 to 0.25',
                                                                 '0.25 to 0.50',
                                                                 '0.50 to 0.75',
                                                                 '0.75 to 0.99',
                                                                 '100% complete'

                                                      ))


agg_data_integration$perc_integrate_assessment_text <- factor( agg_data_integration$perc_integrate_assessment_text,
                                                  levels = c(
                                                          '0.1 to 0.25',
                                                                 '0.25 to 0.50',
                                                                 '0.50 to 0.75',
                                                                 '0.75 to 0.99',
                                                          '100% complete'
                                                  ))








# subnational

agg_data_integration_sub = data_integration_log  %>%
  group_by(country, province) %>%
  summarise(
    tot_policies = n(),
    tot_overlap_assessment = length(which(!is.na(overlap_assessment))),
    tot_integrate_assessment = length(which(!is.na(integrate_assessment))),
    perc_overlap_assessment = tot_overlap_assessment/tot_policies,
    perc_integrate_assessment = tot_integrate_assessment/tot_policies
  ) %>%
  ungroup %>%
  mutate(
    tot_policies_text = case_when(
     tot_policies == 0 ~ as.character(NA),
     tot_policies>0 & tot_policies <= 25 ~'1 to 25',
     tot_policies>25 & tot_policies<=50 ~ '26 to 50',
     tot_policies>50 & tot_policies<=100 ~ '51 to 100',
     tot_policies>100 & tot_policies<=200 ~ '101 to 200',
     tot_policies>200 & tot_policies<=500 ~ '201 to 500',
     tot_policies>500 & tot_policies<=2000 ~ '501 to 2000',
     tot_policies>2000 & tot_policies<=5000 ~ '2001 to 5000',
     tot_policies>5000 & tot_policies<=10000 ~ '5001 to 10000',
     tot_policies>30000 ~ 'More than 30,000'
    ),
    tot_overlap_assessment_text = case_when(
      tot_overlap_assessment  == 0 & tot_policies == 0 ~ as.character(NA),
      tot_overlap_assessment  == 0 & tot_policies != 0 ~ '0',
      tot_overlap_assessment >0 & tot_overlap_assessment<= 25 ~ '1 to 25',
      tot_overlap_assessment >25 & tot_overlap_assessment<= 50 ~ '26 to 50',
      tot_overlap_assessment >50 & tot_overlap_assessment<= 100 ~ '51 to 100',
      tot_overlap_assessment >100 & tot_overlap_assessment<= 200 ~ '101 to 200',
      tot_overlap_assessment>200 & tot_overlap_assessment < 400  ~ '201 to 400',
       tot_overlap_assessment>400    ~ 'More than 400',
    ),
    tot_integrate_assessment_text = case_when(

      tot_integrate_assessment  == 0 & tot_policies == 0 ~ as.character(NA),
      tot_integrate_assessment  == 0 & tot_policies != 0 ~ '0',
      tot_integrate_assessment >0 & tot_integrate_assessment<= 25 ~ '1 to 25',
      tot_integrate_assessment >25 & tot_integrate_assessment<= 50 ~ '26 to 50',
      tot_integrate_assessment >50 & tot_integrate_assessment <= 100 ~ '51 to 100',
      tot_integrate_assessment >100 & tot_integrate_assessment <= 200 ~ '101 to 200',
        tot_integrate_assessment >200 ~ 'More than 200'
    ),
    
    perc_overlap_assessment_text = 
      case_when(
      perc_overlap_assessment == 0 & tot_policies == 0 ~ as.character(NA),
      perc_overlap_assessment == 0 & tot_policies !=0 ~ '0',
       perc_overlap_assessment >0 &  perc_overlap_assessment<=0.25 ~ '0.1 to 0.25',
       perc_overlap_assessment >.25 &  perc_overlap_assessment<=0.5 ~ '0.25 to 0.50',
     perc_overlap_assessment >.5 &  perc_overlap_assessment<=0.75 ~ '0.50 to 0.75',
     perc_overlap_assessment >.75 &  perc_overlap_assessment<1 ~ '0.75 to 0.99',
       perc_overlap_assessment == 1 ~ '100% complete', 
    ),
        perc_integrate_assessment_text = 
      case_when(
      perc_integrate_assessment == 0 & tot_policies == 0 ~ as.character(NA),
      perc_integrate_assessment == 0 & tot_policies !=0 ~ '0',
       perc_integrate_assessment >0 &  perc_integrate_assessment<=0.25 ~ '0.1 to 0.25',
       perc_integrate_assessment >.25 &  perc_integrate_assessment<=0.5 ~ '0.25 to 0.50',
     perc_integrate_assessment >.5 &  perc_integrate_assessment<=0.75 ~ '0.50 to 0.75',
     perc_integrate_assessment >.75 &  perc_integrate_assessment<1 ~ '0.75 to 0.99',
       perc_integrate_assessment == 1 ~ '100% complete', 
    ),
    
  )



agg_data_integration_sub$tot_overlap_assessment_text <- factor( agg_data_integration_sub$tot_overlap_assessment_text,
                                                      levels = c(
                                                                 '1 to 25',
                                                                 '26 to 50',
                                                                 '51 to 100',
                                                                 '101 to 200',
                                                                 '201 to 400',
                                                                 'More than 400'

                                                      ))


agg_data_integration_sub$tot_integrate_assessment_text <- factor( agg_data_integration_sub$tot_integrate_assessment_text,
                                                  levels = c(
                                                             '1 to 25',
                                                             '26 to 50',
                                                             '51 to 100',
                                                             '101 to 200',
                                                             'More than 200'
                                                  ))


agg_data_integration_sub$perc_overlap_assessment_text <- factor( agg_data_integration_sub$perc_overlap_assessment_text,
                                                      levels = c(
                                                                 '0.1 to 0.25',
                                                                 '0.25 to 0.50',
                                                                 '0.50 to 0.75',
                                                                 '0.75 to 0.99',
                                                                 '100% complete'

                                                      ))


agg_data_integration_sub$perc_integrate_assessment_text <- factor( agg_data_integration_sub$perc_integrate_assessment_text,
                                                  levels = c(
                                                          '0.1 to 0.25',
                                                                 '0.25 to 0.50',
                                                                 '0.50 to 0.75',
                                                                 '0.75 to 0.99',
                                                          '100% complete'
                                                  ))




agg_data_integration_sub$tot_policies_text <- factor( agg_data_integration_sub$tot_policies_text,
                                      levels = c(
                                                "1 to 25",
                                                 "26 to 50",
                                                 "51 to 100",
                                                 '101 to 200',
                                                 '201 to 500',
                                                '501 to 2000',
                                                '2001 to 5000',
                                                '5001 to 10000',
                                                'More than 30,000'
                                      ))
# total number of  data integration by country/province
external_sub  =gg + geom_map(data= agg_data_integration_sub %>% dplyr:::select(id = province, everything()),
                                map=shp_df_sub,
                                aes(fill=tot_policies_text, map_id=id  ),
                                size=0.1)


external_sub  = external_sub  + geom_map(data= agg_data_integration_sub %>%  dplyr:::select(id = country, everything()),
                                              map=world_df_sub,
                                              aes(fill=tot_policies_text, map_id=id  ),
                                              size=0.1)




external  = gg  + geom_map(data= agg_data_integration %>%  dplyr:::select(id = country, everything()),
                                         map=world_df,
                                         aes(fill=tot_policies_text, map_id=id  ),
                                         size=0.1)


external +
  scale_fill_viridis_d(na.value = "grey70")+
  theme_void()+
  labs(fill='Number of Policies in External Datasets')+
  coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)



external_sub +
  scale_fill_viridis_d(na.value = "grey70")+
  theme_void()+
  labs(fill='Number of Policies in External Datasets')+
    coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)

```

#### Table
<div style = "width:75%; height:75%; margin: auto;">
```{r integrate_table}

DT::datatable(agg_data_integration_sub %>%
                arrange(country) %>%
                select(
                  country,
                  province ,
                 tot_policies
                )
              ,
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')

```
</div>




### Overlap Assessment {.tabset}

This map and table shows the number of policies that have been assessed for overlap from the external data.


#### Map {.tabset}

##### Total Number 
```{r overlap}
# total number of overlap assessment







## maps

overlap_sub  =gg + geom_map(data= agg_data_integration_sub %>% select(id = province, everything()),
                                map=shp_df_sub,
                                aes(fill=tot_overlap_assessment_text, map_id=id  ),
                                size=0.1)


overlap_sub  = overlap_sub  + geom_map(data= agg_data_integration %>% select(id = country, everything()),
                                              map=world_df_sub,
                                              aes(fill=tot_overlap_assessment_text, map_id=id  ),
                                              size=0.1)

overlap =gg + geom_map(data= agg_data_integration %>% select(id = country, everything()),
                         map=world_df,
                         aes(fill=tot_overlap_assessment_text, map_id=id  ),
                         size=0.1)

overlap +
  scale_fill_viridis_d(na.value = "grey70")+
  theme_void()+
  labs(fill='Number of Overlap Assessments')+
  coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)

overlap_sub +
  scale_fill_viridis_d(na.value = "grey70")+
  theme_void()+
  labs(fill='Number of Overlap Assessments')+
    coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)



```


##### Percentage Overlap
```{r overlap_perc}
# total number of overlap assessment
overlap_sub_perc  =gg + geom_map(data= agg_data_integration_sub %>% select(id = province, everything()),
                                map=shp_df_sub,
                                aes(fill=perc_overlap_assessment_text, map_id=id  ),
                                size=0.1)


overlap_sub_perc  = overlap_sub_perc  + geom_map(data= agg_data_integration %>% select(id = country, everything()),
                                              map=world_df_sub,
                                              aes(fill=perc_overlap_assessment_text, map_id=id  ),
                                              size=0.1)

overlap_perc =gg + geom_map(data= agg_data_integration %>% select(id = country, everything()),
                         map=world_df,
                         aes(fill=perc_overlap_assessment_text, map_id=id  ),
                         size=0.1)

overlap_perc +
  scale_fill_viridis_d(na.value = "grey70")+
  theme_void()+
  labs(fill='Percentage of Overlap Assessments Completed')+
  coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)

overlap_sub_perc +
  scale_fill_viridis_d(na.value = "grey70")+
  theme_void()+
  labs(fill='Percentage of Overlap Assessments Completed')+
    coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)



```


#### Table 


<div style = "width:75%; height:75%; margin: auto;">
```{r overlap_table}

DT::datatable(agg_data_integration %>%
                arrange(country) %>%
                select(
                  country,
              
                 tot_overlap_assessment,
                 perc_overlap_assessment
                )
              ,
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')

```
</div>
 



### Integration Assessment {.tabset}

The map and table show the number of policies that have been assessed for integration from the external data.

#### Maps {.tabset}


##### Total Number

```{r integrate, message = FALSE}
# total number of integrate assessment

integrate_sub  =gg + geom_map(data= agg_data_integration_sub %>% select(id = province, everything()),
                                map=shp_df_sub,
                                aes(fill=tot_integrate_assessment_text, map_id=id  ),
                                size=0.1)


integrate_sub  = integrate_sub  + geom_map(data= agg_data_integration %>% select(id = country, everything()),
                                              map=world_df_sub,
                                              aes(fill=tot_integrate_assessment_text, map_id=id  ),
                                              size=0.1)

integrate =gg + geom_map(data= agg_data_integration %>% select(id = country, everything()),
                         map=world_df,
                         aes(fill=tot_integrate_assessment_text, map_id=id  ),
                         size=0.1)

integrate +
  scale_fill_viridis_d(na.value = "grey70")+
  theme_void()+
  labs(fill='Number of Integration Assessments')+
  coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)

integrate_sub +
  scale_fill_viridis_d(na.value = "grey70")+
  theme_void()+
  labs(fill='Number of Integration Assessments')+
    coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)


```


##### Percentage Overlap


```{r integrate_perc, message = FALSE}
# total number of integrate assessment

integrate_sub_perc  =gg + geom_map(data= agg_data_integration_sub %>% select(id = province, everything()),
                                map=shp_df_sub,
                                aes(fill=perc_integrate_assessment_text, map_id=id  ),
                                size=0.1)


integrate_sub_perc  = integrate_sub_perc  + geom_map(data= agg_data_integration %>% select(id = country, everything()),
                                              map=world_df_sub,
                                              aes(fill=perc_integrate_assessment_text, map_id=id  ),
                                              size=0.1)

integrate_perc =gg + geom_map(data= agg_data_integration %>% select(id = country, everything()),
                         map=world_df,
                         aes(fill=perc_integrate_assessment_text, map_id=id  ),
                         size=0.1)

integrate_perc +
  scale_fill_viridis_d(na.value = "grey70")+
  theme_void()+
  labs(fill='Percentage of Integration Assessments Completed')+
  coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)

integrate_sub_perc +
  scale_fill_viridis_d(na.value = "grey70")+
  theme_void()+
  labs(fill='Percentage of Integration Assessments Completed')+
    coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)


```

#### Table 

<div style = "width:75%; height:75%; margin: auto;">
```{r integrate_assess_table}

DT::datatable(agg_data_integration %>%
                arrange(country) %>%
                select(
                  country,
           
                 tot_integrate_assessment,
                 perc_integrate_assessment
                )
              ,
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')

```
</div>




## Data Quality




### RA Internal Assessment: Policy Cleanliness {.tabset}


This map and table show how clean the data is according to the latest RA Internal Assessment Survey (August 2022 + March 2022 + December 2021 + September 2021). The map displays the average policy clean across all policy types for a given country or subnational region based on the following rubric:

* 1: Looks clean to me
* 2: Mostly there
* 3: About halfway there
* 4: A lot of work left to do

Note that the map sorts this information by the target date that the region is currently being coded up toward.

#### Map

```{r clean}

clean <- gg + geom_map(data=int_assess_agg_sub_nat%>%
                           filter(target_date == '2020-10-01'),
                         map=shp_df_sub,
                         aes(fill=clean_sum, map_id=id  ),
                         size=0.15)+
  scale_fill_gradient(name = "Target: October 1, 2020", low = 'lightblue1', high = 'dodgerblue4',guide = guide_legend(order = 1))


clean  <- clean  + geom_map(data=int_assess_agg_nat %>%
                                 filter(target_date == '2020-10-01')
                               , map=world_df_sub,
                               aes(fill=clean_sum, map_id=id),
                               size=0.15)

clean  <- clean  +
  new_scale_fill(  )+
  geom_map(data=int_assess_agg_sub_nat%>%
             filter(target_date == '2021-03-01'),
           map=shp_df_sub,
           aes(fill=clean_sum, map_id=id  ),
           size=0.15) +
  scale_fill_gradient(name = "Target: March 1, 2021", low = 'palegreen', high = 'darkcyan',guide = guide_legend(order = 2))

clean  <- clean  + geom_map(data=int_assess_agg_nat %>%
                                  filter(target_date == '2021-03-01')
                                , map=world_df_sub,
                                aes(fill=clean_sum, map_id=id),
                                size=0.15)
clean  <- clean  +
  new_scale_fill(  )+
  geom_map(data=int_assess_agg_sub_nat%>%
             filter(target_date == '2021-10-01'),
           map=shp_df_sub,
           aes(fill=clean_sum, map_id=id  ),
           size=0.15) +
  scale_fill_gradient(name = "Target: October 1, 2021", low = 'plum', high = 'darkorchid4',guide = guide_legend(order = 3))


clean  <- clean  + geom_map(data=int_assess_agg_nat %>%
                                filter(target_date == '2021-10-01')
                              , map=world_df_sub,
                              aes(fill=clean_sum, map_id=id),
                              size=0.15)

clean+
  theme_void()+
    coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)
```


#### Table
<div style = "width:75%; height:75%; margin: auto;">
```{r clean_table}

DT::datatable(int_assess_agg_sub_nat %>%
                arrange(country) %>%
                select(
                   survey,
                  country,
                  province = id,
                  target_date,
                 clean_sum
                ),
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')

```
</div>


### Missing End Dates {.tabset}

This map and table shows the total number of policies with missing end dates per country or subnational region up until `r ra_data_pull_purified %>% select(recorded_date) %>% pull %>% max `. Information about the precise policies that still have missing end dates can be [found here](https://drive.google.com/drive/folders/1L724VBmksAB6_Hdvdlvpf1YNx4m8qP6V){target="_blank"} and a video explaining how to fix missing end dates can be [found here](https://www.youtube.com/watch?v=HFh6EyIRjYA){target="_blank"}. 

* The first map shows the number of policies with missing end dates for for countries as a whole
* The second map the number of policies with missing end dates split out by subnational regions for the 12 countries were are systematically collecting subnational data for. Note this map does not include information on national level policies for these 12 countries.

#### Maps
```{r missing, message = FALSE }
missing = ra_data_pull_purified %>%
  mutate(
    quarter = as.yearqtr(recorded_date, format = "%Y-%m-%d"),
    province = ifelse(country %!in% sub_nat, NA, province)
  ) %>%
  group_by(country, province, quarter) %>%
  arrange(quarter) %>%
  summarise(
    missing_end_dates = length(which(is.na(end) & is.na(date_end_spec)))
  ) %>%
  ungroup %>%
  mutate(
    missing_text = case_when(
      missing_end_dates <= 25 ~ "0 to 25",
      missing_end_dates > 20 & missing_end_dates<=50 ~ "25 to 50",
      missing_end_dates > 50 & missing_end_dates<=100 ~ "51 to 100",
      missing_end_dates > 100  ~ "More than 100"),
    quarter = as.character(quarter)

  ) %>%
  distinct



# tot missing
missing_policies_agg_sub =  missing %>%
  group_by(country, province) %>%
  summarise(
    missing_end_dates = sum(missing_end_dates, na.rm = TRUE)
  ) %>%
  ungroup %>%
  mutate(
    missing_text = case_when(
      missing_end_dates <= 25 ~ "0 to 25",
      missing_end_dates> 25 &   missing_end_dates<=50 ~ "25 to 50",
      missing_end_dates> 50 &   missing_end_dates<=100 ~ "51 to 100",
      missing_end_dates> 100 &   missing_end_dates<=200 ~ "101 to 200",
      missing_end_dates> 200  ~ "More than 200",
    )
  )
missing_policies_agg_sub$missing_text <- factor( missing_policies_agg_sub$missing_text,
                                      levels = rev(c("0 to 25",
                                                 "25 to 50",
                                                 "51 to 100",
                                                 "101 to 200",
                                                 'More than 200'
                                      )))


missing_policies_agg =  missing %>%
  group_by(country) %>%
  summarise(
    missing_end_dates = sum(missing_end_dates, na.rm = TRUE)
  ) %>%
  ungroup %>%
  mutate(
    missing_text = case_when(
      missing_end_dates <= 25 ~ "0 to 25",
      missing_end_dates> 25 &   missing_end_dates<=50 ~ "25 to 50",
      missing_end_dates> 50 &   missing_end_dates<=100 ~ "51 to 100",
      missing_end_dates> 100 &   missing_end_dates<=200 ~ "101 to 200",
      missing_end_dates> 200 &   missing_end_dates<=300 ~ "201 to 300",
      missing_end_dates > 300   ~ "More than 300",
    )
  )
missing_policies_agg$missing_text <- factor( missing_policies_agg$missing_text,
                                                 levels = rev(c("0 to 25",
                                                                "25 to 50",
                                                                "51 to 100",
                                                                "101 to 200",
                                                                "201 to 300",
                                                                'More than 300'
                                                 )))




# by country only
agg_missing_end_dates =gg + geom_map(data= missing_policies_agg %>% select(id = country, everything()),
                                     map=world_df,
                                     aes(fill=missing_text, map_id=id  ),
                                     size=0.1)

agg_missing_end_dates +
  scale_fill_viridis_d()+
  theme_void()+
  labs(fill='Number of Missing End Dates')+
    coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)

# by country and subnat
agg_missing_end_dates_sub =gg + geom_map(data= missing_policies_agg_sub %>% select(id = province, everything()),
                            map=shp_df_sub,
                            aes(fill=missing_text, map_id=id  ),
                            size=0.1)


agg_missing_end_dates_sub= agg_missing_end_dates_sub+ geom_map(data= missing_policies_agg_sub %>% select(id = country, everything()),
                                      map=world_df_sub,
                                      aes(fill=missing_text, map_id=id  ),
                                      size=0.1)




agg_missing_end_dates_sub +
  scale_fill_viridis_d()+
  theme_void()+
  labs(fill='Number of Missing End Dates')+
    coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)



```




#### Table
<div style = "width:75%; height:75%; margin: auto;">
```{r missing_table}

DT::datatable(missing_policies_agg_sub  %>%
                arrange(country) %>%
                select(
                  country,
                  province ,
                 missing_end_dates
                )
                ,
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')

```
</div>

### Number of Policies identified as problematic through Automated Checks

TBA



## Data Complexity

### Policy Complexity {.tabset}


This map and table show how complex the data is according to the latest RA Internal Assessment Survey (August 2022 + March 2022 + December 2021 + September 2021). The map displays the average policy complexity across all policy types for a given country or subnational region based on the following rubric:

* 1: Straightforward
* 2: Somewhat complicated
* 3: Very complicated

Note that the map sorts this information by the target date that the region is currently being coded up toward.

#### Map
```{r complex, message = FALSE}

complex <- gg + geom_map(data=int_assess_agg_sub_nat%>%
                            filter(target_date == '2020-10-01'),
                          map=shp_df_sub,
                          aes(fill=complexity_sum, map_id=id  ),
                          size=0.15)+
  scale_fill_gradient(name = "Target: October 1, 2020", low = 'lightblue1', high = 'dodgerblue4',guide = guide_legend(order = 1))


complex <- complex + geom_map(data=int_assess_agg_nat %>%
                                  filter(target_date == '2020-10-01')
                                , map=world_df_sub,
                                aes(fill=complexity_sum, map_id=id),
                                size=0.15)

complex <- complex +
  new_scale_fill(  )+
  geom_map(data=int_assess_agg_sub_nat%>%
             filter(target_date == '2021-03-01'),
           map=shp_df_sub,
           aes(fill=complexity_sum, map_id=id  ),
           size=0.15) +
  scale_fill_gradient(name = "Target: March 1, 2021", low = 'palegreen', high = 'darkcyan',guide = guide_legend(order = 2))

complex <- complex + geom_map(data=int_assess_agg_nat %>%
                                  filter(target_date == '2021-03-01')
                                , map=world_df_sub,
                                aes(fill=complexity_sum, map_id=id),
                                size=0.15)
complex <- complex +
  new_scale_fill(  )+
  geom_map(data=int_assess_agg_sub_nat%>%
             filter(target_date == '2021-10-01'),
           map=shp_df_sub,
           aes(fill=complexity_sum, map_id=id  ),
           size=0.15) +
  scale_fill_gradient(name = "Target: October 1, 2021", low = 'plum', high = 'darkorchid4',guide = guide_legend(order = 3))


complex <- complex + geom_map(data=int_assess_agg_nat %>%
                                  filter(target_date == '2021-10-01')
                                , map=world_df_sub,
                                aes(fill=complexity_sum, map_id=id),
                                size=0.15)

complex+
  theme_void()+
    coord_equal()+
  theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
  theme(aspect.ratio=.75)
```

#### Table
<div style = "width:75%; height:75%; margin: auto;">
```{r complex_table}

DT::datatable(int_assess_agg_sub_nat %>%
                arrange(country) %>%
                select(
                   survey,
                  country,
                  province = id,
                    target_date,
                 complexity_sum
                ),
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')
```
</div>




### RA Internal Assessment: Subnational Policy Making {.tabset}

This map and table show how much subnational policy making there is according to the latest RA Internal Assessment Survey (August 2022 + March 2022 + December 2021 + September 2021). The map and table show the assessment for each quarter from 2020 to 2021. The 'time_frame' variable in the table records each quarter. The map displays the degree of subnational policy making across all policy types for a given country or subnational region based on the following rubric:

* 1: Almost none: Policies were virtually all made at the national level
* 2: A little: There were a few subnational areas where policies differed from everywhere else
* 3: Some: There were some subnational areas where policies were different
* 4 : Almost completely: most subnational measures were very different across subnational regions



#### Map
```{r subnat, fig.height=15, fig.width = 20 }

int_assess_agg_subnatpolicy =
  int_assess_google_clean %>%

  group_by(time_frame, country ,province) %>%
  dplyr:::rowwise() %>%
  mutate(subnat_num = mean(subnat_num, na.rm = TRUE)) %>%
  dplyr:::select(time_frame, country, province, country, subnat_num, survey) %>%
  ungroup %>%
  distinct %>%
  ungroup  

# int_assess_agg_subnatpolicy$subnat <- factor( int_assess_agg_subnatpolicy$subnat,
#                                               levels = c("Almost none: Policies were virtually all made at the national level",
#                                                          "A little: There were a few subnational areas where policies differed from everywhere else",
#                                                          "Some: There were some subnational areas where policies were different",
#                                                          'Almost completely: most subnational measures were very different across subnational regions'
#                                               ))


# int_assess_agg_subnatpolicy =int_assess_agg_subnatpolicy %>%
#   
#   mutate(
#   time_frame = as.character(time_frame),
#       time_frame = case_when(
#     time_frame == "2020.25" ~ "2020 Q2",
#     time_frame == "2020.5" ~ "2020 Q3",
#     time_frame == "2020.75" ~ "2020 Q4",
#     time_frame == "2021.25" ~ "2021 Q2",
#     time_frame == '2021' ~ '2021 Q1',
#     TRUE ~ time_frame
#   ))


subnat =gg + geom_map(data= int_assess_agg_subnatpolicy %>% dplyr:::select(id = province, everything()),
                      map=shp_df_sub,
                      aes(fill=subnat_num, map_id=id  ),
                      size=0.1)

subnat= subnat + geom_map(data= int_assess_agg_subnatpolicy %>% dplyr:::select(id = country, everything()),
                          map=world_df_sub,
                          aes(fill=subnat_num, map_id=id  ),
                          size=0.1)
subnat <-  subnat + facet_wrap(~time_frame, ncol = 2)+
  scale_fill_viridis_c(na.value = "grey70")+
  labs(color='Level of Subnational Policy Making')+
theme_void()+
  guides(fill = guide_legend(reverse = TRUE))

subnat
```


#### Table
<div style = "width:75%; height:75%; margin: auto;">
```{r subnat_table}

DT::datatable(int_assess_agg_subnatpolicy %>%
                arrange(country, province) %>%
                select(
                   survey,
                  country,
                  province,
                  time_frame,
                 subnat_num
                ),
              class = 'cell-border stripe',
              rownames = F,
              filter = 'top')
```
</div>

<!-- <div class="tocify-extend-page" data-unique="tocify-extend-page" style="height: 0;"></div> -->